name: CI

on:
  pull_request:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        if: hashFiles('package.json') != ''
        shell: bash
        run: |
          set -euo pipefail

          if [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm install --frozen-lockfile
            echo "PM=pnpm" >> "$GITHUB_ENV"
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn install --immutable || yarn install --frozen-lockfile || yarn install
            echo "PM=yarn" >> "$GITHUB_ENV"
          elif [ -f package-lock.json ]; then
            npm ci
            echo "PM=npm" >> "$GITHUB_ENV"
          else
            npm install
            echo "PM=npm" >> "$GITHUB_ENV"
          fi

      - name: Lint / Test / Build
        if: hashFiles('package.json') != ''
        shell: bash
        run: |
          set -euo pipefail
          PM="${PM:-npm}"

          if [ "$PM" = "yarn" ]; then
            if node -e "p=require('./package.json');process.exit(p.scripts&&p.scripts.lint?0:1)"; then yarn lint; fi
            if node -e "p=require('./package.json');process.exit(p.scripts&&p.scripts.test?0:1)"; then yarn test; fi
            if node -e "p=require('./package.json');process.exit(p.scripts&&p.scripts.build?0:1)"; then yarn build; fi
          else
            $PM run lint --if-present
            $PM run test --if-present
            $PM run build --if-present
          fi

      - name: Publish legacy required status (build)
        if: ${{ success() }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api -X POST "repos/${GITHUB_REPOSITORY}/statuses/${GITHUB_SHA}" \
            -f state=success -f context=build \
            -f description="CI passed" \
            -f target_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
  statuses: write
