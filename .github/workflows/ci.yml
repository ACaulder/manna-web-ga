name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        shell: bash
        run: |
          if [ ! -f package.json ]; then
            echo "No package.json; skipping install."
            exit 0
          fi

          if [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm -v
            pnpm install --frozen-lockfile
            echo "PM=pnpm" >> "$GITHUB_ENV"
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn -v
            yarn install --immutable || yarn install --frozen-lockfile || yarn install
            echo "PM=yarn" >> "$GITHUB_ENV"
          elif [ -f package-lock.json ]; then
            npm ci
            echo "PM=npm" >> "$GITHUB_ENV"
          else
            npm install
            echo "PM=npm" >> "$GITHUB_ENV"
          fi

      - name: Lint / Test / Build
        shell: bash
        run: |
          if [ ! -f package.json ]; then
            echo "No package.json; skipping scripts."
            exit 0
          fi

          PM="${PM:-npm}"
          if [ "$PM" = "yarn" ]; then
            # yarn has no --if-present; check existence first
            node -e "p=require('./package.json');process.exit(p.scripts&&p.scripts.lint?0:1)" && yarn lint || true
            node -e "p=require('./package.json');process.exit(p.scripts&&p.scripts.test?0:1)" && yarn test || true
            node -e "p=require('./package.json');process.exit(p.scripts&&p.scripts.build?0:1)" && yarn build || true
          else
            $PM run lint --if-present
            $PM test --if-present
            $PM run build --if-present
          fi
